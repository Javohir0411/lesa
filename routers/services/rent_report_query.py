from sqlalchemy.orm import selectinload
from sqlalchemy import select, and_
from db.models import Rent
from datetime import date


async def get_rents_for_report(session, user_db_id: int, start_date: date, end_date: date):
    stmt = (
        select(Rent)
        .options(
            selectinload(Rent.renter),
            selectinload(Rent.product),
        )
        .where(
            and_(
                Rent.user_id == user_db_id,  # <<< MUHIM: faqat shu user
                Rent.start_date >= start_date,
                Rent.end_date <= end_date,
            )
        )
        .order_by(Rent.start_date.asc(), Rent.id.asc())
    )

    result = await session.execute(stmt)
    return result.scalars().all()
